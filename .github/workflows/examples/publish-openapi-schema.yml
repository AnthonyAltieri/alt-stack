name: Publish OpenAPI Schema

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'src/**'
      - 'openapi.json'
  workflow_dispatch:
    inputs:
      openapi_file:
        description: 'Path to OpenAPI JSON file'
        required: false
        default: 'openapi.json'
        type: string
      npm_package_name:
        description: 'NPM package name (defaults to package.json name + -sdk suffix)'
        required: false
        type: string

env:
  OPENAPI_FILE: ${{ github.event.inputs.openapi_file || 'openapi.json' }}
  NPM_PACKAGE_NAME: ${{ github.event.inputs.npm_package_name || '' }}

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
        continue-on-error: true

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Read package.json
        id: package
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

      - name: Set NPM package name
        id: npm_package
        run: |
          if [ -n "${{ env.NPM_PACKAGE_NAME }}" ]; then
            echo "name=${{ env.NPM_PACKAGE_NAME }}" >> $GITHUB_OUTPUT
          else
            # Default: append -sdk to package name
            SDK_NAME="${{ steps.package.outputs.name }}-sdk"
            echo "name=$SDK_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Install zod-openapi CLI
        run: pnpm add -D @alt-stack/zod-openapi

      - name: Generate OpenAPI spec (if generate-spec script exists)
        run: |
          if npm run generate-spec --if-present 2>/dev/null; then
            echo "Generated OpenAPI spec"
          else
            echo "No generate-spec script found, using existing ${{ env.OPENAPI_FILE }}"
          fi

      - name: Verify OpenAPI file exists
        run: |
          if [ ! -f "${{ env.OPENAPI_FILE }}" ]; then
            echo "Error: OpenAPI file not found at ${{ env.OPENAPI_FILE }}"
            exit 1
          fi
          echo "Found OpenAPI spec at ${{ env.OPENAPI_FILE }}"

      - name: Generate SDK
        run: |
          mkdir -p sdk-package/src
          echo "Generating SDK from ${{ env.OPENAPI_FILE }}"
          npx zod-openapi "${{ env.OPENAPI_FILE }}" -o sdk-package/src/index.ts

      - name: Create package.json for npm package
        run: |
          cat > sdk-package/package.json << EOF
          {
            "name": "${{ steps.npm_package.outputs.name }}",
            "version": "${{ steps.package.outputs.version }}",
            "description": "Auto-generated TypeScript SDK from OpenAPI schema",
            "type": "module",
            "main": "./dist/index.js",
            "module": "./dist/index.mjs",
            "types": "./dist/index.d.ts",
            "exports": {
              ".": {
                "types": "./dist/index.d.ts",
                "import": "./dist/index.mjs",
                "require": "./dist/index.js"
              }
            },
            "files": [
              "dist",
              "src"
            ],
            "scripts": {
              "build": "tsup src/index.ts --format cjs,esm --dts"
            },
            "keywords": [
              "sdk",
              "openapi",
              "typescript",
              "zod"
            ],
            "license": "MIT",
            "repository": {
              "type": "git",
              "url": "${{ github.server_url }}/${{ github.repository }}.git"
            },
            "peerDependencies": {
              "zod": "^4.0.0"
            },
            "devDependencies": {
              "tsup": "^8.0.0",
              "typescript": "^5.0.0"
            }
          }
          EOF

      - name: Create tsconfig.json
        run: |
          cat > sdk-package/tsconfig.json << EOF
          {
            "compilerOptions": {
              "target": "ES2022",
              "module": "ESNext",
              "moduleResolution": "bundler",
              "strict": true,
              "esModuleInterop": true,
              "skipLibCheck": true,
              "declaration": true,
              "outDir": "./dist"
            },
            "include": ["src"]
          }
          EOF

      - name: Create README.md
        run: |
          cat > sdk-package/README.md << EOF
          # ${{ steps.npm_package.outputs.name }}

          Auto-generated TypeScript SDK from OpenAPI schema.

          ## Installation

          \`\`\`bash
          pnpm add ${{ steps.npm_package.outputs.name }}
          # or
          npm install ${{ steps.npm_package.outputs.name }}
          \`\`\`

          ## Usage

          \`\`\`typescript
          import { schemas, Request, Response } from '${{ steps.npm_package.outputs.name }}';

          // Use Zod schemas for validation
          const validated = schemas.MySchema.parse(data);

          // Use Request/Response types for type-safe API calls
          type MyEndpointRequest = Request<'POST /api/endpoint'>;
          type MyEndpointResponse = Response<'POST /api/endpoint'>;
          \`\`\`

          ## Generation

          This package is automatically generated from the server's OpenAPI specification.
          Do not manually edit the contents of this package.

          Generated from commit: \`${{ github.sha }}\`
          EOF

      - name: Build SDK
        working-directory: sdk-package
        run: |
          pnpm install
          pnpm build

      - name: Configure npm
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "Error: NPM_TOKEN secret is required"
            exit 1
          fi
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc

      - name: Publish to npm
        working-directory: sdk-package
        run: npm publish --access public

      - name: Cleanup
        if: always()
        run: rm -rf sdk-package .npmrc || true
